#!/usr/bin/env bash

CONFIG="$HOME/dotfiles/tmux/session-colors"
CACHE="$HOME/.cache/sessionizer-repos"

# Refresh cache in background (runs every time, but non-blocking)
refresh_cache() {
    {
        fd -H --no-ignore-vcs '^\.git$' ~/dev --max-depth 5 | sed -E 's|/\.git/?$||'
        echo "$HOME/.notes"
        echo "$HOME/dotfiles"
    } | sort -u > "$CACHE.tmp" && mv "$CACHE.tmp" "$CACHE"
}
refresh_cache &

# Use cache if exists, otherwise generate now
if [[ -f "$CACHE" ]]; then
    selected=$(fzf --reverse < "$CACHE")
else
    selected=$({
        fd -H --no-ignore-vcs '^\.git$' ~/dev --max-depth 5 | sed -E 's|/\.git/?$||'
        echo "$HOME/.notes"
        echo "$HOME/dotfiles"
    } | sort -u | fzf --reverse)
fi

[[ -z $selected ]] && exit 0

# Session name from folder name, replace dots/spaces with underscores
session_name=$(basename "$selected" | tr './ ' '___')

# Apply saved color for session
apply_session_color() {
    local session="$1"
    local color
    local dark="#1a1b26"

    if [[ -f "$CONFIG" ]]; then
        color=$(grep "^${session}:" "$CONFIG" | cut -d: -f2)
    fi

    if [[ -n $color ]]; then
        tmux set-option -t "$session" @session_color "$color"
        tmux set-option -g status-bg "$color"
        tmux set-option -g status-fg "$dark"
        tmux set-option -g status-left "#[bg=$color,fg=$dark,bold] #S "
        tmux set-option -g status-right "#[bg=$color,fg=$dark] %a %d %b %H:%M "
        tmux set-option -g window-status-current-format "#[bg=$color,fg=$dark,bold] #I:#{?window_zoomed_flag,ó°Š“ ,}[#{P:#{?pane_active,*,}#{pane_current_command} }] "
        tmux set-option -g window-status-format "#[bg=$color,fg=$dark] #I:[#{P:#{pane_current_command} }] "
    fi
}

# Function to create session with layout
create_session() {
    # Create session with first window
    tmux new-session -ds "$session_name" -c "$selected" -n "editor"

    # Window 1: nvim (2/3) | claude (1/3)
    tmux split-window -t "$session_name:editor" -h -l 33% -c "$selected"

    # pane 1 = nvim with explorer (left), pane 2 = claude (right)
    tmux send-keys -t "$session_name:editor.1" 'nvim +"lua Snacks.explorer()"' Enter
    tmux send-keys -t "$session_name:editor.2" "cc" Enter

    # Window 2: plain shell
    tmux new-window -t "$session_name" -n "shell" -c "$selected"

    # Focus back on nvim
    tmux select-window -t "$session_name:editor"
    tmux select-pane -t "$session_name:editor.1"
}

# Not in tmux - create and attach
if [[ -z $TMUX ]]; then
    if ! tmux has-session -t="$session_name" 2>/dev/null; then
        create_session
        apply_session_color "$session_name"
    fi
    tmux attach -t "$session_name"
    exit 0
fi

# In tmux - create if needed, then switch
if ! tmux has-session -t="$session_name" 2>/dev/null; then
    create_session
    apply_session_color "$session_name"
fi

tmux switch-client -t "$session_name"
