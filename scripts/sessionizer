#!/usr/bin/env bash

# Find git repos and worktrees, select with fzf
selected=$(fd -H --no-ignore '^\.git$' ~/dev --max-depth 5 -x dirname {} | sort -u | fzf --reverse)

[[ -z $selected ]] && exit 0

# Session name from folder name, replace dots/spaces with underscores
session_name=$(basename "$selected" | tr './ ' '___')

# Function to create session with layout
create_session() {
    # Create session with first window
    tmux new-session -ds "$session_name" -c "$selected" -n "editor"

    # Window 1: nvim (2/3) | claude (1/3)
    tmux split-window -t "$session_name:editor" -h -l 33% -c "$selected"

    # pane 1 = nvim with explorer (left), pane 2 = claude (right)
    tmux send-keys -t "$session_name:editor.1" 'nvim +"lua Snacks.explorer()"' Enter
    tmux send-keys -t "$session_name:editor.2" "cc" Enter

    # Window 2: plain shell
    tmux new-window -t "$session_name" -n "shell" -c "$selected"

    # Focus back on nvim
    tmux select-window -t "$session_name:editor"
    tmux select-pane -t "$session_name:editor.1"
}

# Not in tmux - create and attach
if [[ -z $TMUX ]]; then
    if ! tmux has-session -t="$session_name" 2>/dev/null; then
        create_session
    fi
    tmux attach -t "$session_name"
    exit 0
fi

# In tmux - create if needed, then switch
if ! tmux has-session -t="$session_name" 2>/dev/null; then
    create_session
fi

tmux switch-client -t "$session_name"
