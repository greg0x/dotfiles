#!/usr/bin/env bash

CONFIG="$HOME/dotfiles/tmux/session-colors"
HISTORY="$HOME/.cache/sessionizer-history"

# Get paths for currently open tmux sessions
get_session_paths() {
    tmux list-sessions -F '#{session_name}' 2>/dev/null | while read -r session; do
        # Get the working directory of the first pane in the first window
        tmux display-message -t "$session:1.1" -p '#{pane_current_path}' 2>/dev/null
    done
}

# Build list: open sessions first, then recent, then all directories
selected=$({
    get_session_paths
    [[ -f "$HISTORY" ]] && cat "$HISTORY"
    fd -H --type d --max-depth 4 . ~/dev
    echo "$HOME/notes"
    echo "$HOME/dotfiles"
} | awk '!seen[$0]++' | fzf --reverse)

[[ -z $selected ]] && exit 0

# Update history: add selection to top, keep last 20
{
    echo "$selected"
    [[ -f "$HISTORY" ]] && grep -v "^${selected}$" "$HISTORY" | head -19
} > "$HISTORY.tmp" && mv "$HISTORY.tmp" "$HISTORY"

# Session name from folder name, replace dots/spaces with underscores
session_name=$(basename "$selected" | tr './ ' '___')

# Apply saved color for session
apply_session_color() {
    local session="$1"
    local color
    local dark="#1a1b26"

    if [[ -f "$CONFIG" ]]; then
        color=$(grep "^${session}:" "$CONFIG" | cut -d: -f2)
    fi

    if [[ -n $color ]]; then
        tmux set-option -t "$session" @session_color "$color"
        tmux set-option -g status-bg "$color"
        tmux set-option -g status-fg "$dark"
        tmux set-option -g status-left "#[bg=$color,fg=$dark,bold] #S "
        tmux set-option -g status-right "#[bg=$color,fg=$dark] %a %d %b %H:%M "
        tmux set-option -g window-status-current-format "#[bg=$color,fg=$dark,bold] #I:#{?window_zoomed_flag,ó°Š“ ,}[#{P:#{?pane_active,*,}#{pane_current_command} }] "
        tmux set-option -g window-status-format "#[bg=$color,fg=$dark] #I:[#{P:#{pane_current_command} }] "
    fi
}

# Function to create session with layout
create_session() {
    # Create session with first window
    tmux new-session -ds "$session_name" -c "$selected" -n "editor"

    # Window 1: nvim (2/3) | claude (1/3)
    tmux split-window -t "$session_name:editor" -h -l 33% -c "$selected"

    # pane 1 = nvim with explorer (left), pane 2 = claude (right)
    tmux send-keys -t "$session_name:editor.1" 'nvim' Enter
    tmux send-keys -t "$session_name:editor.2" "cc" Enter

    # Window 2: plain shell
    tmux new-window -t "$session_name" -n "shell" -c "$selected"

    # Focus back on nvim
    tmux select-window -t "$session_name:editor"
    tmux select-pane -t "$session_name:editor.1"
}

# Not in tmux - create and attach
if [[ -z $TMUX ]]; then
    if ! tmux has-session -t="$session_name" 2>/dev/null; then
        create_session
        apply_session_color "$session_name"
    fi
    tmux attach -t "$session_name"
    exit 0
fi

# In tmux - create if needed, then switch
if ! tmux has-session -t="$session_name" 2>/dev/null; then
    create_session
    apply_session_color "$session_name"
fi

tmux switch-client -t "$session_name"
