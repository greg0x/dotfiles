#!/bin/bash
# dev-clean: recursively find and remove regenerable build artifacts
# Usage: dev-clean [directory]  (defaults to current directory)
#        dev-clean --dry-run [directory]  (show what would be removed)

set -euo pipefail

DRY_RUN=false
TARGET_DIR="."

for arg in "$@"; do
  case "$arg" in
    --dry-run|-n) DRY_RUN=true ;;
    *) TARGET_DIR="$arg" ;;
  esac
done

TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

# Patterns: [directory name] matched by exact name
# These are always safe to remove — they're generated by build tools
ARTIFACT_DIRS=(
  # Rust
  "target"
  # Swift
  ".build"
  # Node.js
  "node_modules"
  # Python
  ".venv"
  "__pycache__"
  ".mypy_cache"
  ".pytest_cache"
  ".ruff_cache"
  # Go
  "vendor"  # only if go.sum exists alongside
  # General
  "dist"
  ".next"
  ".nuxt"
  ".turbo"
)

# Files: large generated files matched by pattern
ARTIFACT_FILE_PATTERNS=(
  "*.profraw"
  "heaptrack.*.gz"
)

total_bytes=0
declare -a found_paths=()
declare -a found_sizes=()

format_size() {
  local bytes=$1
  if (( bytes >= 1073741824 )); then
    printf "%.1fG" "$(echo "scale=1; $bytes / 1073741824" | bc)"
  elif (( bytes >= 1048576 )); then
    printf "%.0fM" "$(echo "scale=0; $bytes / 1048576" | bc)"
  elif (( bytes >= 1024 )); then
    printf "%.0fK" "$(echo "scale=0; $bytes / 1024" | bc)"
  else
    printf "%dB" "$bytes"
  fi
}

# Find artifact directories, but don't descend into them (avoids double-counting)
for pattern in "${ARTIFACT_DIRS[@]}"; do
  while IFS= read -r dir; do
    # Skip if inside another artifact dir (e.g. target/ inside node_modules/)
    skip=false
    for check in "${ARTIFACT_DIRS[@]}"; do
      if [[ "$dir" == *"/$check/"* ]] && [[ "$check" != "$pattern" ]]; then
        skip=true
        break
      fi
    done
    $skip && continue

    # Special case: only remove "vendor" if go.sum exists alongside
    if [[ "$pattern" == "vendor" ]]; then
      parent="$(dirname "$dir")"
      [[ ! -f "$parent/go.sum" ]] && continue
    fi

    # Special case: skip "dist" if it looks like source (has non-build files)
    if [[ "$pattern" == "dist" ]]; then
      # Only remove if parent has a package.json (Node project)
      parent="$(dirname "$dir")"
      [[ ! -f "$parent/package.json" ]] && continue
    fi

    bytes=$(du -sk "$dir" 2>/dev/null | awk '{print $1 * 1024}')
    (( bytes < 1048576 )) && continue  # skip if < 1MB

    found_paths+=("$dir")
    found_sizes+=("$bytes")
    total_bytes=$((total_bytes + bytes))
  done < <(find "$TARGET_DIR" -type d -name "$pattern" -not -path "*/.git/*" 2>/dev/null)
done

# Find large artifact files
for pattern in "${ARTIFACT_FILE_PATTERNS[@]}"; do
  while IFS= read -r file; do
    # Skip if inside an artifact dir we're already removing
    skip=false
    for dir in "${found_paths[@]}"; do
      [[ "$file" == "$dir"/* ]] && { skip=true; break; }
    done
    $skip && continue

    bytes=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    (( bytes < 1048576 )) && continue

    found_paths+=("$file")
    found_sizes+=("$bytes")
    total_bytes=$((total_bytes + bytes))
  done < <(find "$TARGET_DIR" -type f -name "$pattern" -not -path "*/.git/*" 2>/dev/null)
done

if [[ ${#found_paths[@]} -eq 0 ]]; then
  echo "No build artifacts found (>1MB) in $TARGET_DIR"
  exit 0
fi

# Sort by size descending
indices=($(for i in "${!found_sizes[@]}"; do echo "$i ${found_sizes[$i]}"; done | sort -rnk2 | awk '{print $1}'))

echo ""
echo "Build artifacts found in $TARGET_DIR:"
echo ""
printf "  %-8s  %s\n" "SIZE" "PATH"
printf "  %-8s  %s\n" "--------" "----"
for i in "${indices[@]}"; do
  rel_path="${found_paths[$i]#$TARGET_DIR/}"
  printf "  %-8s  %s\n" "$(format_size "${found_sizes[$i]}")" "$rel_path"
done
echo ""
echo "  Total: $(format_size $total_bytes)"
echo ""

if $DRY_RUN; then
  echo "(dry run — nothing removed)"
  exit 0
fi

read -p "Remove all? [y/N] " confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  for path in "${found_paths[@]}"; do
    rm -rf "$path"
  done
  echo "Done. Freed ~$(format_size $total_bytes)"
else
  echo "Cancelled."
fi
